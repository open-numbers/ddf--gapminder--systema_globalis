# recipe for dataset
info:
    id: sg-dataset

config:
    # the path to search recipe files to include
    recipes_dir: ./
    # the path to search dictionary files
    dictionary_dir: ../translation_dictionaries
    # the path to search ddf datasets
    ddf_dir: /Users/semio/src/work/Gapminder/datasets/
    # external
    external_csv_dir: ../external_csv
    # procedures
    procedure_dir: ./procedures

include:
    - recipe_gw_common.yaml
    - recipe_gw_lex_only.yaml
    - recipe_gw_gdp.yaml
    - recipe_gw_co2.yaml
    - recipe_gw_pop.yaml
    - recipe_wdi.yaml
    - recipe_gw_gini.yaml
    - recipe_ihme_edu_attainment.yml
    - recipe_unpop.yaml

ingredients:
    - id: gw-concepts-all
      dataset: open-numbers/ddf--gapminder--gapminder_world
      key: concept
      value: "*"
      filter:
          concept:
              $nin: &concepts_to_drop
                  - yearly_co2_emissions_tonnes
                  - sg_gdp_p_cap_const_ppp2011_dollar
                  - sg_population
                  - sg_gini
                  - geographic_regions_in_4_colors
                  - unit
    - id: gw-ontology-concepts
      dataset: open-numbers/ddf--gapminder--ontology
      key: concept
    - id: gw-datapoints-all
      dataset: open-numbers/ddf--gapminder--gapminder_world
      key: "geo,time"
      value:
          $nin: *concepts_to_drop
    - id: static-assets-datapoints
      dataset: open-numbers/ddf--gapminder--static_assets
      key: geo, time
      value: "*"
    - id: static-assets-concepts
      dataset: open-numbers/ddf--gapminder--static_assets
      key: concept
      value: "*"

    # external csvs
    - id: concept_patch
      key: concept
      data: ddf--concepts.csv

    - id: tag_entity
      key: tag
      data: ddf--entities--tag.csv

    - id: geo_global_patch
      key: geo
      data: ddf--entities--geo--global.csv

cooking:
    datapoints:
        - procedure: merge
          result: all-datapoints-merged
          ingredients:
              - gw-datapoints-all
              - lex-datapoints-final
              - gdp-datapoints-final
              - pop-datapoints-final
              - co2-datapoints-final
              - wdi-datapoints-final
              - gini-datapoints
              - edu-datapoints-final
              - unpop-datapoints-final
              - static-assets-datapoints
        - procedure: filter
          result: datapoints-final
          ingredients:
          - all-datapoints-merged
          options:
              item:
                  $nin:
                    - co2_intensity_of_economic_output_kg_co2_per_2005_ppp_of_gdp
                    - extreme_poverty_percent_people_below_125_a_day
                    - gnipercapita_constant_2000_us
                    - poverty_percent_people_below_2_a_day
    entities:
        - procedure: merge
          ingredients:
              - gw-entities-geo
              - geo_global_patch
          options:
              deep: true
          result: geo_final
        - procedure: serve
          ingredients:
              - geo_final
              - tag_entity
    concepts:
        - procedure: merge
          result: all-concepts-merged
          ingredients:
              - gw-concepts-all-wdi-translated
              - static-assets-concepts
              - gw-concepts-geo
              - gw-concepts-discrete
              - lex-concepts-final
              - gdp-concepts-final
              - pop-concepts-final
              - co2-concepts-final
              - gini-concepts
              - edu-concepts-final
              - unpop-concepts-final
              - gw-ontology-concepts
          options:
              deep: true
        - procedure: translate_column
          ingredients:
            - all-concepts-merged
          result: all-concepts-merged-translated
          options:
              column: concept
              not_found: include
              dictionary:
                  geographic_regions: world_6region
        - procedure: merge
          ingredients:
              - all-concepts-merged-translated
              - concept_patch
          options:
              deep: true
          result: concepts_final
        - procedure: filter
          ingredients:
            - concepts_final
          options:
            item:
              $nin:
                - unit
            row:
              concept:
                  $nin:
                      - unit
                      - age
          result: concepts_final_no_unit
